"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var SQLite = require("nativescript-sqlite");
var DatabaseService = /** @class */ (function () {
    function DatabaseService() {
        this.DB_NAME = "cosacompro.db";
        this.PRODUCTS_TABLE_NAME = "products";
        this.GROCERYLIST_TABLE_NAME = "grocerylist";
        this.MYLISTS_TABLE_NAME = "list";
    }
    DatabaseService.prototype.createGroceryList = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return (new SQLite(_this.DB_NAME)).then(function (db) {
                db.execSQL("\n            CREATE TABLE IF NOT EXISTS " + _this.GROCERYLIST_TABLE_NAME + " (\n              glist_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL DEFAULT (0),\n              quantity INTEGER DEFAULT (1),\n              product_id_fk INTEGER NOT NULL,\n              list_id_fk INTEGER NOT NULL,\n              FOREIGN KEY (product_id_fk) REFERENCES list (glist_id),\n              FOREIGN KEY (list_id_fk) REFERENCES product (product_id)\n            )\n          ")
                    .then(function () {
                    resolve(db);
                }, function (error) {
                    console.log("[DATABASE SERVICE ERROR] createDB -> create table:", error);
                    reject(error);
                });
            }, function (error) {
                console.log("[DATABASE SERVICE ERROR] createDB:", error);
                reject(error);
            });
        });
    };
    DatabaseService.prototype.createMyLists = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return (new SQLite(_this.DB_NAME)).then(function (db) {
                db.execSQL("\n          CREATE TABLE IF NOT EXISTS " + _this.MYLISTS_TABLE_NAME + " (\n            glist_id INTEGER PRIMARY KEY NOT NULL DEFAULT (0),\n            glist_name TEXT NOT NULL,\n            start TEXT,\n            end TEXT\n          )\n        ")
                    .then(function () {
                    resolve(db);
                }, function (error) {
                    console.log("[DATABASE SERVICE ERROR] createDB -> create table:", error);
                    reject(error);
                });
            }, function (error) {
                console.log("[DATABASE SERVICE ERROR] createDB:", error);
                reject(error);
            });
        });
    };
    DatabaseService.prototype.insertGrocery = function (grocerie) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.createGroceryList()
                .then(function (res) {
                res.execSQL("INSERT INTO " + _this.GROCERYLIST_TABLE_NAME + " (BARCODE, PRODUCT_NAME) VALUES (?, ?)", [grocerie.barCode, grocerie.productName])
                    .then(function (id) {
                    console.log("[DATABASE SERVICE] Added record in " + _this.GROCERYLIST_TABLE_NAME + " table, id: ", id);
                    resolve(true);
                }, function (error) {
                    console.log("[DATABASE SERVICE] Insert record in " + _this.GROCERYLIST_TABLE_NAME + " table ERROR: ", error);
                    reject(false);
                });
            });
        });
    };
    DatabaseService.prototype.getMyLists = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all("SELECT * FROM " + _this.MYLISTS_TABLE_NAME).then(function (rows) {
                    var result = [];
                    rows.forEach(function (row) {
                        result.push({
                            listId: row[0],
                            listName: row[1],
                            startDate: row[2],
                            endDate: row[3]
                        });
                    });
                    resolve(result);
                }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] getGroceries:", error);
                    reject(error);
                };
            });
        });
    };
    DatabaseService.prototype.getGroceryList = function (listId) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all("\n            SELECT\n              " + _this.MYLISTS_TABLE_NAME + ".glist_id as glist_id,\n              glist_name,\n              product_name,\n              brand,\n              quantity\n            FROM " + _this.GROCERYLIST_TABLE_NAME + "\n            INNER JOIN " + _this.MYLISTS_TABLE_NAME + " ON " + _this.MYLISTS_TABLE_NAME + ".glist_id = " + _this.GROCERYLIST_TABLE_NAME + ".list_id_fk\n            INNER JOIN " + _this.PRODUCTS_TABLE_NAME + " ON " + _this.PRODUCTS_TABLE_NAME + ".product_id = " + _this.GROCERYLIST_TABLE_NAME + ".product_id_fk\n            WHERE list_id_fk = " + listId + " ORDER BY glist_id COLLATE NOCASE\n          ").then(function (rows) {
                    var result = [];
                    rows.forEach(function (row) {
                        result.push({
                            productName: row[2],
                            brand: row[3],
                            quantity: row[4]
                        });
                    });
                    resolve(result);
                }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] getGroceries:", error);
                    reject(error);
                };
            });
        });
    };
    DatabaseService = __decorate([
        core_1.Injectable()
    ], DatabaseService);
    return DatabaseService;
}());
exports.DatabaseService = DatabaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhdGFiYXNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFFM0MsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFHNUM7SUFEQTtRQUdVLFlBQU8sR0FBVyxlQUFlLENBQUM7UUFDbEMsd0JBQW1CLEdBQVcsVUFBVSxDQUFDO1FBQ3pDLDJCQUFzQixHQUFXLGFBQWEsQ0FBQztRQUMvQyx1QkFBa0IsR0FBVyxNQUFNLENBQUM7SUF5SDlDLENBQUM7SUF2SFMsMkNBQWlCLEdBQXpCO1FBQUEsaUJBd0JDO1FBdkJDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ2pDLE1BQU0sQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEVBQUU7Z0JBQ3ZDLEVBQUUsQ0FBQyxPQUFPLENBQUMsOENBQ3NCLEtBQUksQ0FBQyxzQkFBc0IseVlBUXpELENBQUM7cUJBQ0QsSUFBSSxDQUFDO29CQUNKLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDZCxDQUFDLEVBQUUsVUFBQSxLQUFLO29CQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQ3pFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3pELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVPLHVDQUFhLEdBQXJCO1FBQUEsaUJBc0JDO1FBckJDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ2pDLE1BQU0sQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEVBQUU7Z0JBQ3ZDLEVBQUUsQ0FBQyxPQUFPLENBQUMsNENBQ29CLEtBQUksQ0FBQyxrQkFBa0Isb0xBTXJELENBQUM7cUJBQ0MsSUFBSSxDQUFDO29CQUNKLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDZCxDQUFDLEVBQUUsVUFBQSxLQUFLO29CQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQ3pFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3pELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVNLHVDQUFhLEdBQXBCLFVBQXFCLFFBQWE7UUFBbEMsaUJBY0M7UUFiQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxLQUFJLENBQUMsaUJBQWlCLEVBQUU7aUJBQ3JCLElBQUksQ0FBQyxVQUFDLEdBQVE7Z0JBQ2IsR0FBRyxDQUFDLE9BQU8sQ0FBQyxpQkFBZSxLQUFJLENBQUMsc0JBQXNCLDJDQUF3QyxFQUFFLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7cUJBQ3RJLElBQUksQ0FBQyxVQUFBLEVBQUU7b0JBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBc0MsS0FBSSxDQUFDLHNCQUFzQixpQkFBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNqRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsRUFBRSxVQUFBLEtBQUs7b0JBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyx5Q0FBdUMsS0FBSSxDQUFDLHNCQUFzQixtQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDdkcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoQixDQUFDLENBQUMsQ0FBQTtZQUNOLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sb0NBQVUsR0FBakI7UUFBQSxpQkFvQkM7UUFuQkMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsS0FBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsR0FBUTtnQkFDckMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsbUJBQWlCLEtBQUksQ0FBQyxrQkFBb0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUk7b0JBQ2xFLElBQUksTUFBTSxHQUFlLEVBQUUsQ0FBQztvQkFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUc7d0JBQ2QsTUFBTSxDQUFDLElBQUksQ0FBQzs0QkFDVixNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQzs0QkFDZCxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQzs0QkFDaEIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQ2pCLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO3lCQUNoQixDQUFDLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsRUFBRSxVQUFBLEtBQUs7b0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDN0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoQixDQUFDLENBQUE7WUFDSCxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLHdDQUFjLEdBQXJCLFVBQXNCLE1BQWM7UUFBcEMsaUJBOEJDO1FBN0JDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ2pDLEtBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQVE7Z0JBQ3JDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLHlDQUVQLEtBQUksQ0FBQyxrQkFBa0IsdUpBS3BCLEtBQUksQ0FBQyxzQkFBc0IsaUNBQ3JCLEtBQUksQ0FBQyxrQkFBa0IsWUFBTyxLQUFJLENBQUMsa0JBQWtCLG9CQUFlLEtBQUksQ0FBQyxzQkFBc0IsNENBQy9GLEtBQUksQ0FBQyxtQkFBbUIsWUFBTyxLQUFJLENBQUMsbUJBQW1CLHNCQUFpQixLQUFJLENBQUMsc0JBQXNCLHVEQUMzRixNQUFNLGtEQUM1QixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSTtvQkFDVixJQUFJLE1BQU0sR0FBZSxFQUFFLENBQUM7b0JBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHO3dCQUNkLE1BQU0sQ0FBQyxJQUFJLENBQUM7NEJBQ1YsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7NEJBQ25CLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDOzRCQUNiLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO3lCQUNqQixDQUFDLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsRUFBRSxVQUFBLEtBQUs7b0JBQ1AsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDN0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNoQixDQUFDLENBQUE7WUFDTCxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQTdIVSxlQUFlO1FBRDNCLGlCQUFVLEVBQUU7T0FDQSxlQUFlLENBOEgzQjtJQUFELHNCQUFDO0NBQUEsQUE5SEQsSUE4SEM7QUE5SFksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuXHJcbmxldCBTUUxpdGUgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXNxbGl0ZVwiKTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIERhdGFiYXNlU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgREJfTkFNRTogc3RyaW5nID0gXCJjb3NhY29tcHJvLmRiXCI7XHJcbiAgcHJpdmF0ZSBQUk9EVUNUU19UQUJMRV9OQU1FOiBzdHJpbmcgPSBcInByb2R1Y3RzXCI7XHJcbiAgcHJpdmF0ZSBHUk9DRVJZTElTVF9UQUJMRV9OQU1FOiBzdHJpbmcgPSBcImdyb2NlcnlsaXN0XCI7XHJcbiAgcHJpdmF0ZSBNWUxJU1RTX1RBQkxFX05BTUU6IHN0cmluZyA9IFwibGlzdFwiO1xyXG5cclxuICBwcml2YXRlIGNyZWF0ZUdyb2NlcnlMaXN0KCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgcmV0dXJuIChuZXcgU1FMaXRlKHRoaXMuREJfTkFNRSkpLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgIGRiLmV4ZWNTUUwoYFxyXG4gICAgICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuR1JPQ0VSWUxJU1RfVEFCTEVfTkFNRX0gKFxyXG4gICAgICAgICAgICAgIGdsaXN0X2lkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCBOT1QgTlVMTCBERUZBVUxUICgwKSxcclxuICAgICAgICAgICAgICBxdWFudGl0eSBJTlRFR0VSIERFRkFVTFQgKDEpLFxyXG4gICAgICAgICAgICAgIHByb2R1Y3RfaWRfZmsgSU5URUdFUiBOT1QgTlVMTCxcclxuICAgICAgICAgICAgICBsaXN0X2lkX2ZrIElOVEVHRVIgTk9UIE5VTEwsXHJcbiAgICAgICAgICAgICAgRk9SRUlHTiBLRVkgKHByb2R1Y3RfaWRfZmspIFJFRkVSRU5DRVMgbGlzdCAoZ2xpc3RfaWQpLFxyXG4gICAgICAgICAgICAgIEZPUkVJR04gS0VZIChsaXN0X2lkX2ZrKSBSRUZFUkVOQ0VTIHByb2R1Y3QgKHByb2R1Y3RfaWQpXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgIGApXHJcbiAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZGIpO1xyXG4gICAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBjcmVhdGVEQiAtPiBjcmVhdGUgdGFibGU6XCIsIGVycm9yKTtcclxuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJbREFUQUJBU0UgU0VSVklDRSBFUlJPUl0gY3JlYXRlREI6XCIsIGVycm9yKTtcclxuICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlTXlMaXN0cygpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHJldHVybiAobmV3IFNRTGl0ZSh0aGlzLkRCX05BTUUpKS50aGVuKGRiID0+IHtcclxuICAgICAgICBkYi5leGVjU1FMKGBcclxuICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9IChcclxuICAgICAgICAgICAgZ2xpc3RfaWQgSU5URUdFUiBQUklNQVJZIEtFWSBOT1QgTlVMTCBERUZBVUxUICgwKSxcclxuICAgICAgICAgICAgZ2xpc3RfbmFtZSBURVhUIE5PVCBOVUxMLFxyXG4gICAgICAgICAgICBzdGFydCBURVhULFxyXG4gICAgICAgICAgICBlbmQgVEVYVFxyXG4gICAgICAgICAgKVxyXG4gICAgICAgIGApXHJcbiAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZGIpO1xyXG4gICAgICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBjcmVhdGVEQiAtPiBjcmVhdGUgdGFibGU6XCIsIGVycm9yKTtcclxuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJbREFUQUJBU0UgU0VSVklDRSBFUlJPUl0gY3JlYXRlREI6XCIsIGVycm9yKTtcclxuICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIHB1YmxpYyBpbnNlcnRHcm9jZXJ5KGdyb2NlcmllOiBhbnkpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuY3JlYXRlR3JvY2VyeUxpc3QoKVxyXG4gICAgICAgIC50aGVuKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgcmVzLmV4ZWNTUUwoYElOU0VSVCBJTlRPICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfSAoQkFSQ09ERSwgUFJPRFVDVF9OQU1FKSBWQUxVRVMgKD8sID8pYCwgW2dyb2NlcmllLmJhckNvZGUsIGdyb2NlcmllLnByb2R1Y3ROYW1lXSlcclxuICAgICAgICAgICAgLnRoZW4oaWQgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbREFUQUJBU0UgU0VSVklDRV0gQWRkZWQgcmVjb3JkIGluICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfSB0YWJsZSwgaWQ6IGAsIGlkKTtcclxuICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtEQVRBQkFTRSBTRVJWSUNFXSBJbnNlcnQgcmVjb3JkIGluICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfSB0YWJsZSBFUlJPUjogYCwgZXJyb3IpO1xyXG4gICAgICAgICAgICAgIHJlamVjdChmYWxzZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldE15TGlzdHMoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmNyZWF0ZUdyb2NlcnlMaXN0KCkudGhlbigocmVzOiBhbnkpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzLmFsbChgU0VMRUNUICogRlJPTSAke3RoaXMuTVlMSVNUU19UQUJMRV9OQU1FfWApLnRoZW4ocm93cyA9PiB7XHJcbiAgICAgICAgICBsZXQgcmVzdWx0OiBBcnJheTxhbnk+ID0gW107XHJcbiAgICAgICAgICByb3dzLmZvckVhY2gocm93ID0+IHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgICAgIGxpc3RJZDogcm93WzBdLFxyXG4gICAgICAgICAgICAgIGxpc3ROYW1lOiByb3dbMV0sXHJcbiAgICAgICAgICAgICAgc3RhcnREYXRlOiByb3dbMl0sXHJcbiAgICAgICAgICAgICAgZW5kRGF0ZTogcm93WzNdXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgfSksIGVycm9yID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKFwiW0RBVEFCQVNFIFNFUlZJQ0UgRVJST1JdIGdldEdyb2NlcmllczpcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRHcm9jZXJ5TGlzdChsaXN0SWQ6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5jcmVhdGVHcm9jZXJ5TGlzdCgpLnRoZW4oKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5hbGwoYFxyXG4gICAgICAgICAgICBTRUxFQ1RcclxuICAgICAgICAgICAgICAke3RoaXMuTVlMSVNUU19UQUJMRV9OQU1FfS5nbGlzdF9pZCBhcyBnbGlzdF9pZCxcclxuICAgICAgICAgICAgICBnbGlzdF9uYW1lLFxyXG4gICAgICAgICAgICAgIHByb2R1Y3RfbmFtZSxcclxuICAgICAgICAgICAgICBicmFuZCxcclxuICAgICAgICAgICAgICBxdWFudGl0eVxyXG4gICAgICAgICAgICBGUk9NICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfVxyXG4gICAgICAgICAgICBJTk5FUiBKT0lOICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9IE9OICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9LmdsaXN0X2lkID0gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9Lmxpc3RfaWRfZmtcclxuICAgICAgICAgICAgSU5ORVIgSk9JTiAke3RoaXMuUFJPRFVDVFNfVEFCTEVfTkFNRX0gT04gJHt0aGlzLlBST0RVQ1RTX1RBQkxFX05BTUV9LnByb2R1Y3RfaWQgPSAke3RoaXMuR1JPQ0VSWUxJU1RfVEFCTEVfTkFNRX0ucHJvZHVjdF9pZF9ma1xyXG4gICAgICAgICAgICBXSEVSRSBsaXN0X2lkX2ZrID0gJHtsaXN0SWR9IE9SREVSIEJZIGdsaXN0X2lkIENPTExBVEUgTk9DQVNFXHJcbiAgICAgICAgICBgKS50aGVuKHJvd3MgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcmVzdWx0OiBBcnJheTxhbnk+ID0gW107XHJcbiAgICAgICAgICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHByb2R1Y3ROYW1lOiByb3dbMl0sXHJcbiAgICAgICAgICAgICAgICBicmFuZDogcm93WzNdLFxyXG4gICAgICAgICAgICAgICAgcXVhbnRpdHk6IHJvd1s0XVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgICAgfSksIGVycm9yID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJbREFUQUJBU0UgU0VSVklDRSBFUlJPUl0gZ2V0R3JvY2VyaWVzOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICB9KTtcclxuICB9XHJcbn0iXX0=