"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var SQLite = require("nativescript-sqlite");
var DatabaseService = /** @class */ (function () {
    function DatabaseService() {
        this.DB_NAME = "cosacompro.db";
        this.PRODUCTS_TABLE_NAME = "products";
        this.GROCERYLIST_TABLE_NAME = "grocerylist";
        this.MYLISTS_TABLE_NAME = "list";
    }
    DatabaseService.prototype.createGroceryList = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return (new SQLite(_this.DB_NAME)).then(function (db) {
                db.execSQL("\n            CREATE TABLE IF NOT EXISTS " + _this.GROCERYLIST_TABLE_NAME + " (\n              glist_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL DEFAULT (0),\n              quantity INTEGER DEFAULT (1),\n              product_id_fk INTEGER NOT NULL,\n              list_id_fk INTEGER NOT NULL,\n              FOREIGN KEY (product_id_fk) REFERENCES list (glist_id),\n              FOREIGN KEY (list_id_fk) REFERENCES product (product_id)\n            )\n          ")
                    .then(function () {
                    resolve(db);
                }, function (error) {
                    console.log("[DATABASE SERVICE ERROR] createDB -> create table:", error);
                    reject(error);
                });
            }, function (error) {
                console.log("[DATABASE SERVICE ERROR] createDB:", error);
                reject(error);
            });
        });
    };
    DatabaseService.prototype.createMyLists = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return (new SQLite(_this.DB_NAME)).then(function (db) {
                db.execSQL("\n          CREATE TABLE IF NOT EXISTS " + _this.MYLISTS_TABLE_NAME + " (\n            glist_id INTEGER PRIMARY KEY NOT NULL DEFAULT (0),\n            glist_name TEXT NOT NULL,\n            start TEXT,\n            end TEXT\n          )\n        ")
                    .then(function () {
                    resolve(db);
                }, function (error) {
                    console.log("[DATABASE SERVICE ERROR] createDB -> create table:", error);
                    reject(error);
                });
            }, function (error) {
                console.log("[DATABASE SERVICE ERROR] createDB:", error);
                reject(error);
            });
        });
    };
    DatabaseService.prototype.insertGrocery = function (grocerie) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.createGroceryList()
                .then(function (res) {
                res.execSQL("INSERT INTO " + _this.GROCERYLIST_TABLE_NAME + " (BARCODE, PRODUCT_NAME) VALUES (?, ?)", [grocerie.barCode, grocerie.productName])
                    .then(function (id) {
                    console.log("[DATABASE SERVICE] Added record in " + _this.GROCERYLIST_TABLE_NAME + " table, id: ", id);
                    resolve(true);
                }, function (error) {
                    console.log("[DATABASE SERVICE] Insert record in " + _this.GROCERYLIST_TABLE_NAME + " table ERROR: ", error);
                    reject(false);
                });
            });
        });
    };
    DatabaseService.prototype.getMyLists = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all("SELECT * FROM " + _this.MYLISTS_TABLE_NAME).then(function (rows) {
                    var result = [];
                    rows.forEach(function (row) {
                        result.push({
                            listId: row[0],
                            listName: row[1],
                            startDate: row[2],
                            endDate: row[3]
                        });
                    });
                    resolve(result);
                }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] getGroceries:", error);
                    reject(error);
                };
            });
        });
    };
    DatabaseService.prototype.getGroceryListDetails = function (listId) {
        var _this = this;
        var queryString = "\n      SELECT\n        " + this.MYLISTS_TABLE_NAME + ".glist_id as glist_id,\n        groceryList.glist_id as id,\n        glist_name,\n        product_id_fk,\n        product_name,\n        brand,\n        quantity\n      FROM " + this.GROCERYLIST_TABLE_NAME + "\n      INNER JOIN " + this.MYLISTS_TABLE_NAME + " ON " + this.MYLISTS_TABLE_NAME + ".glist_id = " + this.GROCERYLIST_TABLE_NAME + ".list_id_fk\n      INNER JOIN " + this.PRODUCTS_TABLE_NAME + " ON " + this.PRODUCTS_TABLE_NAME + ".product_id = " + this.GROCERYLIST_TABLE_NAME + ".product_id_fk\n      WHERE list_id_fk = " + listId + " ORDER BY glist_id COLLATE NOCASE\n    ";
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all(queryString).then(function (rows) {
                    var result = [];
                    rows.forEach(function (row) {
                        console.log(JSON.stringify(row));
                        result.push({
                            id: row[1],
                            productId: row[3],
                            productName: row[4],
                            brand: row[5],
                            quantity: row[6]
                        });
                    });
                    resolve(result);
                }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] getGroceries:", error);
                    reject(error);
                };
            });
        });
    };
    DatabaseService.prototype.insertIntoGroceryListDetails = function (listId, productId, quantity) {
        var _this = this;
        var queryString = "\n      INSERT INTO " + this.GROCERYLIST_TABLE_NAME + " (product_id_fk, list_id_fk, quantity)\n      VALUES (" + productId + ", " + listId + ", " + quantity + ")\n    ";
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all(queryString).then((function (rows) { return resolve(true); }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] insertIntoGroceryListDetails");
                    console.log(queryString);
                    reject(error);
                }), function (error) { return reject(error); };
            });
        });
    };
    DatabaseService.prototype.updateGroceryListDetails = function (glistId, listId, productId, quantity) {
        var _this = this;
        var queryString = "\n      UPDATE " + this.GROCERYLIST_TABLE_NAME + "\n      SET product_id_fk=" + productId + ", list_id_fk=" + listId + ", quantity=" + quantity + "\n      WHERE glist_id=" + glistId + "\n    ";
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all(queryString).then((function (rows) { return resolve(true); }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] updateGroceryListDetails");
                    console.log(queryString);
                    reject(error);
                }), function (error) { return reject(error); };
            });
        });
    };
    DatabaseService.prototype.deleteGroceryListItem = function (id) {
        var _this = this;
        var queryString = "\n      DELETE FROM " + this.GROCERYLIST_TABLE_NAME + "\n      WHERE glist_id=" + id + "\n    ";
        return new Promise(function (resolve, reject) {
            _this.createGroceryList().then(function (res) {
                return res.all(queryString).then((function (rows) { return resolve(true); }), function (error) {
                    console.log("[DATABASE SERVICE ERROR] deleteGroceryListItem");
                    console.log(queryString);
                    reject(error);
                }), function (error) { return reject(error); };
            });
        });
    };
    DatabaseService = __decorate([
        core_1.Injectable()
    ], DatabaseService);
    return DatabaseService;
}());
exports.DatabaseService = DatabaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhdGFiYXNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFFM0MsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFHNUM7SUFEQTtRQUdVLFlBQU8sR0FBVyxlQUFlLENBQUM7UUFDbEMsd0JBQW1CLEdBQVcsVUFBVSxDQUFDO1FBQ3pDLDJCQUFzQixHQUFXLGFBQWEsQ0FBQztRQUMvQyx1QkFBa0IsR0FBVyxNQUFNLENBQUM7SUFvTDlDLENBQUM7SUFsTFMsMkNBQWlCLEdBQXpCO1FBQUEsaUJBd0JDO1FBdkJDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ2pDLE1BQU0sQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEVBQUU7Z0JBQ3ZDLEVBQUUsQ0FBQyxPQUFPLENBQUMsOENBQ3NCLEtBQUksQ0FBQyxzQkFBc0IseVlBUXpELENBQUM7cUJBQ0QsSUFBSSxDQUFDO29CQUNKLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDZCxDQUFDLEVBQUUsVUFBQSxLQUFLO29CQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQ3pFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3pELE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVPLHVDQUFhLEdBQXJCO1FB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QUksT0FBQSxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQWIsQ0FBYSxDQUFDLEVBQUUsVUFBQSxLQUFLO29CQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7b0JBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQ3pCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEIsQ0FBQyxDQUFDLEVBQUUsVUFBQSxLQUFLLElBQUksT0FBQSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQWIsQ0FBYSxDQUFBO1lBQzVCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBeExVLGVBQWU7UUFEM0IsaUJBQVUsRUFBRTtPQUNBLGVBQWUsQ0F5TDNCO0lBQUQsc0JBQUM7Q0FBQSxBQXpMRCxJQXlMQztBQXpMWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5cclxubGV0IFNRTGl0ZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0YWJhc2VTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBEQl9OQU1FOiBzdHJpbmcgPSBcImNvc2Fjb21wcm8uZGJcIjtcclxuICBwcml2YXRlIFBST0RVQ1RTX1RBQkxFX05BTUU6IHN0cmluZyA9IFwicHJvZHVjdHNcIjtcclxuICBwcml2YXRlIEdST0NFUllMSVNUX1RBQkxFX05BTUU6IHN0cmluZyA9IFwiZ3JvY2VyeWxpc3RcIjtcclxuICBwcml2YXRlIE1ZTElTVFNfVEFCTEVfTkFNRTogc3RyaW5nID0gXCJsaXN0XCI7XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlR3JvY2VyeUxpc3QoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICByZXR1cm4gKG5ldyBTUUxpdGUodGhpcy5EQl9OQU1FKSkudGhlbihkYiA9PiB7XHJcbiAgICAgICAgZGIuZXhlY1NRTChgXHJcbiAgICAgICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfSAoXHJcbiAgICAgICAgICAgICAgZ2xpc3RfaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5UIE5PVCBOVUxMIERFRkFVTFQgKDApLFxyXG4gICAgICAgICAgICAgIHF1YW50aXR5IElOVEVHRVIgREVGQVVMVCAoMSksXHJcbiAgICAgICAgICAgICAgcHJvZHVjdF9pZF9mayBJTlRFR0VSIE5PVCBOVUxMLFxyXG4gICAgICAgICAgICAgIGxpc3RfaWRfZmsgSU5URUdFUiBOT1QgTlVMTCxcclxuICAgICAgICAgICAgICBGT1JFSUdOIEtFWSAocHJvZHVjdF9pZF9maykgUkVGRVJFTkNFUyBsaXN0IChnbGlzdF9pZCksXHJcbiAgICAgICAgICAgICAgRk9SRUlHTiBLRVkgKGxpc3RfaWRfZmspIFJFRkVSRU5DRVMgcHJvZHVjdCAocHJvZHVjdF9pZClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgYClcclxuICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShkYik7XHJcbiAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiW0RBVEFCQVNFIFNFUlZJQ0UgRVJST1JdIGNyZWF0ZURCIC0+IGNyZWF0ZSB0YWJsZTpcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBjcmVhdGVEQjpcIiwgZXJyb3IpO1xyXG4gICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVNeUxpc3RzKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgcmV0dXJuIChuZXcgU1FMaXRlKHRoaXMuREJfTkFNRSkpLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgIGRiLmV4ZWNTUUwoYFxyXG4gICAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLk1ZTElTVFNfVEFCTEVfTkFNRX0gKFxyXG4gICAgICAgICAgICBnbGlzdF9pZCBJTlRFR0VSIFBSSU1BUlkgS0VZIE5PVCBOVUxMIERFRkFVTFQgKDApLFxyXG4gICAgICAgICAgICBnbGlzdF9uYW1lIFRFWFQgTk9UIE5VTEwsXHJcbiAgICAgICAgICAgIHN0YXJ0IFRFWFQsXHJcbiAgICAgICAgICAgIGVuZCBURVhUXHJcbiAgICAgICAgICApXHJcbiAgICAgICAgYClcclxuICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShkYik7XHJcbiAgICAgICAgICB9LCBlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiW0RBVEFCQVNFIFNFUlZJQ0UgRVJST1JdIGNyZWF0ZURCIC0+IGNyZWF0ZSB0YWJsZTpcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBjcmVhdGVEQjpcIiwgZXJyb3IpO1xyXG4gICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgIH0pXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGluc2VydEdyb2NlcnkoZ3JvY2VyaWU6IGFueSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5jcmVhdGVHcm9jZXJ5TGlzdCgpXHJcbiAgICAgICAgLnRoZW4oKHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgICByZXMuZXhlY1NRTChgSU5TRVJUIElOVE8gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9IChCQVJDT0RFLCBQUk9EVUNUX05BTUUpIFZBTFVFUyAoPywgPylgLCBbZ3JvY2VyaWUuYmFyQ29kZSwgZ3JvY2VyaWUucHJvZHVjdE5hbWVdKVxyXG4gICAgICAgICAgICAudGhlbihpZCA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtEQVRBQkFTRSBTRVJWSUNFXSBBZGRlZCByZWNvcmQgaW4gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9IHRhYmxlLCBpZDogYCwgaWQpO1xyXG4gICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIH0sIGVycm9yID0+IHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW0RBVEFCQVNFIFNFUlZJQ0VdIEluc2VydCByZWNvcmQgaW4gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9IHRhYmxlIEVSUk9SOiBgLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KGZhbHNlKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0TXlMaXN0cygpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuY3JlYXRlR3JvY2VyeUxpc3QoKS50aGVuKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXMuYWxsKGBTRUxFQ1QgKiBGUk9NICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9YCkudGhlbihyb3dzID0+IHtcclxuICAgICAgICAgIGxldCByZXN1bHQ6IEFycmF5PGFueT4gPSBbXTtcclxuICAgICAgICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7XHJcbiAgICAgICAgICAgICAgbGlzdElkOiByb3dbMF0sXHJcbiAgICAgICAgICAgICAgbGlzdE5hbWU6IHJvd1sxXSxcclxuICAgICAgICAgICAgICBzdGFydERhdGU6IHJvd1syXSxcclxuICAgICAgICAgICAgICBlbmREYXRlOiByb3dbM11cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICB9KSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJbREFUQUJBU0UgU0VSVklDRSBFUlJPUl0gZ2V0R3JvY2VyaWVzOlwiLCBlcnJvcik7XHJcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldEdyb2NlcnlMaXN0RGV0YWlscyhsaXN0SWQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgcXVlcnlTdHJpbmc6IHN0cmluZyA9IGBcclxuICAgICAgU0VMRUNUXHJcbiAgICAgICAgJHt0aGlzLk1ZTElTVFNfVEFCTEVfTkFNRX0uZ2xpc3RfaWQgYXMgZ2xpc3RfaWQsXHJcbiAgICAgICAgZ3JvY2VyeUxpc3QuZ2xpc3RfaWQgYXMgaWQsXHJcbiAgICAgICAgZ2xpc3RfbmFtZSxcclxuICAgICAgICBwcm9kdWN0X2lkX2ZrLFxyXG4gICAgICAgIHByb2R1Y3RfbmFtZSxcclxuICAgICAgICBicmFuZCxcclxuICAgICAgICBxdWFudGl0eVxyXG4gICAgICBGUk9NICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfVxyXG4gICAgICBJTk5FUiBKT0lOICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9IE9OICR7dGhpcy5NWUxJU1RTX1RBQkxFX05BTUV9LmdsaXN0X2lkID0gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9Lmxpc3RfaWRfZmtcclxuICAgICAgSU5ORVIgSk9JTiAke3RoaXMuUFJPRFVDVFNfVEFCTEVfTkFNRX0gT04gJHt0aGlzLlBST0RVQ1RTX1RBQkxFX05BTUV9LnByb2R1Y3RfaWQgPSAke3RoaXMuR1JPQ0VSWUxJU1RfVEFCTEVfTkFNRX0ucHJvZHVjdF9pZF9ma1xyXG4gICAgICBXSEVSRSBsaXN0X2lkX2ZrID0gJHtsaXN0SWR9IE9SREVSIEJZIGdsaXN0X2lkIENPTExBVEUgTk9DQVNFXHJcbiAgICBgO1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuY3JlYXRlR3JvY2VyeUxpc3QoKS50aGVuKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXMuYWxsKHF1ZXJ5U3RyaW5nKS50aGVuKHJvd3MgPT4ge1xyXG4gICAgICAgICAgbGV0IHJlc3VsdDogQXJyYXk8YW55PiA9IFtdO1xyXG4gICAgICAgICAgcm93cy5mb3JFYWNoKHJvdyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJvdykpO1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7XHJcbiAgICAgICAgICAgICAgaWQ6IHJvd1sxXSxcclxuICAgICAgICAgICAgICBwcm9kdWN0SWQ6IHJvd1szXSxcclxuICAgICAgICAgICAgICBwcm9kdWN0TmFtZTogcm93WzRdLFxyXG4gICAgICAgICAgICAgIGJyYW5kOiByb3dbNV0sXHJcbiAgICAgICAgICAgICAgcXVhbnRpdHk6IHJvd1s2XVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgIH0pLCBlcnJvciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBnZXRHcm9jZXJpZXM6XCIsIGVycm9yKTtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaW5zZXJ0SW50b0dyb2NlcnlMaXN0RGV0YWlscyhsaXN0SWQ6IG51bWJlciwgcHJvZHVjdElkOiBudW1iZXIsIHF1YW50aXR5OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IHF1ZXJ5U3RyaW5nOiBzdHJpbmcgPSBgXHJcbiAgICAgIElOU0VSVCBJTlRPICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfSAocHJvZHVjdF9pZF9maywgbGlzdF9pZF9maywgcXVhbnRpdHkpXHJcbiAgICAgIFZBTFVFUyAoJHtwcm9kdWN0SWR9LCAke2xpc3RJZH0sICR7cXVhbnRpdHl9KVxyXG4gICAgYDtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmNyZWF0ZUdyb2NlcnlMaXN0KCkudGhlbigocmVzOiBhbnkpID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzLmFsbChxdWVyeVN0cmluZykudGhlbigocm93cyA9PiByZXNvbHZlKHRydWUpKSwgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJbREFUQUJBU0UgU0VSVklDRSBFUlJPUl0gaW5zZXJ0SW50b0dyb2NlcnlMaXN0RGV0YWlsc1wiKTtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKHF1ZXJ5U3RyaW5nKTtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSksIGVycm9yID0+IHJlamVjdChlcnJvcilcclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHVwZGF0ZUdyb2NlcnlMaXN0RGV0YWlscyhnbGlzdElkOiBudW1iZXIsIGxpc3RJZDogbnVtYmVyLCBwcm9kdWN0SWQ6IG51bWJlciwgcXVhbnRpdHk6IG51bWJlcikge1xyXG4gICAgY29uc3QgcXVlcnlTdHJpbmc6IHN0cmluZyA9IGBcclxuICAgICAgVVBEQVRFICR7dGhpcy5HUk9DRVJZTElTVF9UQUJMRV9OQU1FfVxyXG4gICAgICBTRVQgcHJvZHVjdF9pZF9maz0ke3Byb2R1Y3RJZH0sIGxpc3RfaWRfZms9JHtsaXN0SWR9LCBxdWFudGl0eT0ke3F1YW50aXR5fVxyXG4gICAgICBXSEVSRSBnbGlzdF9pZD0ke2dsaXN0SWR9XHJcbiAgICBgO1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuY3JlYXRlR3JvY2VyeUxpc3QoKS50aGVuKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXMuYWxsKHF1ZXJ5U3RyaW5nKS50aGVuKChyb3dzID0+IHJlc29sdmUodHJ1ZSkpLCBlcnJvciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSB1cGRhdGVHcm9jZXJ5TGlzdERldGFpbHNcIik7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhxdWVyeVN0cmluZyk7XHJcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgIH0pLCBlcnJvciA9PiByZWplY3QoZXJyb3IpXHJcbiAgICAgIH0pXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkZWxldGVHcm9jZXJ5TGlzdEl0ZW0oaWQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgcXVlcnlTdHJpbmc6IHN0cmluZyA9IGBcclxuICAgICAgREVMRVRFIEZST00gJHt0aGlzLkdST0NFUllMSVNUX1RBQkxFX05BTUV9XHJcbiAgICAgIFdIRVJFIGdsaXN0X2lkPSR7aWR9XHJcbiAgICBgO1xyXG5cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuY3JlYXRlR3JvY2VyeUxpc3QoKS50aGVuKChyZXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXMuYWxsKHF1ZXJ5U3RyaW5nKS50aGVuKChyb3dzID0+IHJlc29sdmUodHJ1ZSkpLCBlcnJvciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhcIltEQVRBQkFTRSBTRVJWSUNFIEVSUk9SXSBkZWxldGVHcm9jZXJ5TGlzdEl0ZW1cIik7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhxdWVyeVN0cmluZyk7XHJcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgIH0pLCBlcnJvciA9PiByZWplY3QoZXJyb3IpXHJcbiAgICAgIH0pXHJcbiAgICB9KTtcclxuICB9XHJcbn0iXX0=